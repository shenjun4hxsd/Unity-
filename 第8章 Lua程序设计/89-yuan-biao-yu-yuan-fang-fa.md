##å…ƒè¡¨ï¼ˆmetatableï¼‰ä¸å…ƒæ–¹æ³•ï¼ˆmeatmethodï¼‰

&emsp;&emsp;é€šå¸¸ï¼ŒLuaä¸­çš„æ¯ä¸ªå€¼éƒ½æœ‰ä¸€å¥—é¢„å®šä¹‰çš„æ“ä½œé›†åˆã€‚ä¾‹å¦‚ï¼Œå¯ä»¥å°†æ•°å­—ç›¸åŠ ï¼Œå¯ä»¥è¿æ¥å­—ç¬¦ä¸²ï¼Œè¿˜å¯ä»¥åœ¨tableä¸­æ’å…¥ä¸€å¯¹key-valueç­‰ã€‚ä½†æ˜¯æˆ‘ä»¬æ— æ³•å°†ä¸¤ä¸ªtableç›¸åŠ ï¼Œæ— æ³•å¯¹å‡½æ•°ä½œæ¯”è¾ƒï¼Œä¹Ÿæ— æ³•è°ƒç”¨ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚

&emsp;&emsp;å¯ä»¥é€šè¿‡å…ƒè¡¨æ¥ä¿®æ”¹ä¸€ä¸ªå€¼çš„è¡Œä¸ºï¼Œä½¿å…¶åœ¨é¢å¯¹ä¸€ä¸ªéé¢„å®šä¹‰çš„æ“ä½œæ—¶æ‰§è¡Œä¸€ä¸ªæŒ‡å®šçš„æ“ä½œã€‚ä¾‹å¦‚ï¼Œå‡è®¾aå’Œbéƒ½æ˜¯tableï¼Œé€šè¿‡å…ƒè¡¨å¯ä»¥å®šä¹‰å¦‚ä½•è®¡ç®—è¡¨è¾¾å¼a+bã€‚å½“Luaè¯•å›¾å°†ä¸¤ä¸ªtableç›¸åŠ æ—¶ï¼Œå®ƒä¼šå…ˆæ£€æŸ¥ä¸¤è€…ä¹‹ä¸€æ˜¯å¦æœ‰å…ƒè¡¨ï¼Œç„¶åæ£€æŸ¥è¯¥å…ƒè¡¨ä¸­æ˜¯å¦æœ‰ä¸€ä¸ªå«__addçš„å­—æ®µã€‚å¦‚æœLuaæ‰¾åˆ°äº†è¯¥å­—æ®µï¼Œå°±è°ƒç”¨è¯¥å­—æ®µå¯¹åº”çš„å€¼ã€‚è¿™ä¸ªå€¼ä¹Ÿå°±æ˜¯æ‰€è°“çš„â€œå…ƒæ–¹æ³•â€ï¼Œå®ƒåº”è¯¥æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œè¿™ä¸ªå‡½æ•°ç”¨äºè®¡ç®—tableçš„å’Œã€‚

&emsp;&emsp;**Luaä¸­çš„æ¯ä¸ªå€¼éƒ½æœ‰ä¸€ä¸ªå…ƒè¡¨**ã€‚tableå’Œuserdataå¯ä»¥æœ‰å„è‡ªç‹¬ç«‹çš„å…ƒè¡¨ï¼Œè€Œå…¶ä»–ç±»å‹çš„å€¼åˆ™å…±äº«å…¶ç±»å‹æ‰€å±çš„å•ä¸€å…ƒè¡¨ã€‚**Luaåœ¨åˆ›å»ºæ–°çš„tableæ—¶ä¸ä¼šåˆ›å»ºå…ƒè¡¨**ï¼š

```lua
    t = {}
    print(getmetatable(t))        --> nil
```

&emsp;&emsp;å¯ä»¥ä½¿ç”¨setmetatableæ¥è®¾ç½®æˆ–ä¿®æ”¹ä»»ä½•tableçš„å…ƒè¡¨ï¼š

```lua
    t1 = {}
    setmetatable(t, t1)
    assert(getmetatable(t) == t1)
```

&emsp;&emsp;ä»»ä½•tableéƒ½å¯ä»¥ä½œä¸ºä»»ä½•å€¼çš„å…ƒè¡¨ï¼Œè€Œä¸€ç»„ç›¸å…³çš„tableä¹Ÿå¯ä»¥å…±äº«ä¸€ä¸ªé€šç”¨çš„å…ƒè¡¨ï¼Œæ­¤å…ƒè¡¨æè¿°äº†å®ƒä»¬çš„å…±åŒçš„è¡Œä¸ºã€‚ä¸€ä¸ªtableç”šè‡³å¯ä»¥ä½œä¸ºå®ƒè‡ªå·±çš„å…ƒè¡¨ï¼Œç”¨äºæè¿°å…¶ç‰¹æœ‰çš„è¡Œä¸ºã€‚æ€»ä¹‹ï¼Œä»»ä½•æ­é…å½¢å¼éƒ½æ˜¯åˆæ³•çš„ã€‚

&emsp;&emsp;**åœ¨Luaä»£ç ä¸­ï¼Œåªèƒ½è®¾ç½®tableçš„å…ƒè¡¨**ã€‚è‹¥è¦è®¾ç½®å…¶ä»–ç±»å‹çš„å€¼çš„å…ƒè¡¨ï¼Œåˆ™å¿…é¡»é€šè¿‡Cä»£ç æ¥å®Œæˆã€‚åœ¨ç¬¬20ç« ä¸­ï¼Œå°†ä¼šçœ‹åˆ°æ ‡å‡†çš„å­—ç¬¦ä¸²ç¨‹åºåº“ä¸ºæ‰€æœ‰çš„å­—ç¬¦ä¸²éƒ½è®¾ç½®äº†ä¸€ä¸ªå…ƒè¡¨ï¼Œè€Œå…¶ä»–ç±»å‹åœ¨é»˜è®¤æƒ…å†µä¸­éƒ½æ²¡æœ‰å…ƒè¡¨ã€‚

```lua
    print(getmetatable("hi")         --> table:0x80772e0
    print(getmetatable(10))          --> nil
```

&emsp;&emsp;

####ç®—æœ¯ç±»çš„å…ƒæ–¹æ³•

&emsp;&emsp;åœ¨æœ¬èŠ‚ä¸­ï¼Œä¼šå¼•å…¥ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œä»¥è¯´æ˜å¦‚ä½•ä½¿ç”¨å…ƒè¡¨ã€‚å‡è®¾ç”¨tableæ¥è¡¨ç¤ºé›†åˆï¼Œå¹¶ä¸”æœ‰ä¸€äº›å‡½æ•°ç”¨æ¥è®¡ç®—é›†åˆçš„å¹¶é›†å’Œäº¤é›†ç­‰ã€‚ä¸ºäº†ä¿æŒåç§°ç©ºé—´çš„æ•´é½ï¼Œåˆ™å°†è¿™äº›å‡½æ•°å­˜å…¥ä¸€ä¸ªåä¸ºSetçš„tableä¸­ã€‚

```lua
    Set = {}
    
    -- æ ¹æ®å‚æ•°åˆ—è¡¨ä¸­çš„å€¼åˆ›å»ºä¸€ä¸ªæ–°çš„é›†åˆ
    function Set.new(l)
        local set = {}
        for _, v in ipairs(l) do set[v] = true end
        return set
    end
    
    function Set.union(a, b)
        local res = Set.new{}
        for k in pairs(a) do res[k] = true end
        for k in pairs(b) do res[k] = true end
        return res
    end
    
    function Set.intersection(a, b)
        local res = Set.new{}
        for k in pairs(a) do
            res[k] = b[k]
        end
        return res
    end
```

&emsp;&emsp;ä¸ºäº†å¸®åŠ©æ£€æŸ¥æ­¤ç¤ºä¾‹ï¼Œè¿˜å®šä¹‰äº†ä¸€ä¸ªç”¨äºæ‰“å°é›†åˆçš„å‡½æ•°ï¼š

```lua
    function Set.tostring(set)
        local l = {}        -- ç”¨äºå­˜æ”¾é›†åˆä¸­æ‰€æœ‰å…ƒç´ çš„åˆ—è¡¨
        for e in pairs(set) do
            l[#l + 1] = e
        end
        return "{" .. table.concat(l, ", " .. "}"
    end
    
    function Set.print(s)
        print(Set.tostring(s))
    end
```

&emsp;&emsp;å‡è®¾ä½¿ç”¨åŠ å·ï¼ˆ`+`ï¼‰æ¥è®¡ç®—ä¸¤ä¸ªé›†åˆçš„å¹¶é›†ï¼Œé‚£ä¹ˆå°±éœ€è¦è®©æ‰€æœ‰ç”¨äºè¡¨ç¤ºé›†åˆçš„tableå…±äº«ä¸€ä¸ªå…ƒè¡¨ï¼Œå¹¶ä¸”åœ¨è¯¥å…ƒè¡¨ä¸­å®šä¹‰å¦‚ä½•æ‰§è¡Œä¸€ä¸ªåŠ æ³•æ“ä½œã€‚ç¬¬ä¸€æ­¥æ˜¯åˆ›å»ºä¸€ä¸ªå¸¸è§„çš„tableï¼Œå‡†å¤‡ç”¨ä½œé›†åˆçš„å…ƒè¡¨ï¼š

```lua
    local mt = {}        -- é›†åˆçš„å…ƒè¡¨
```

&emsp;&emsp;ä¸‹ä¸€æ­¥æ˜¯ä¿®æ”¹Set.newå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°æ˜¯ç”¨äºåˆ›å»ºé›†åˆçš„ï¼Œåœ¨æ–°ç‰ˆæœ¬ä¸­åªåŠ äº†ä¸€è¡Œï¼Œå³å°†mtè®¾ç½®ä¸ºå½“å‰æ‰€åˆ›å»ºtableçš„å…ƒè¡¨ï¼š

```lua
    function Set.new(l)        -- ç¬¬2ç‰ˆ
        local set = {}
        setmetatable(set, mt)
        for _, v in ipairs(l) do set[v] = true end
        return set
    end
```

&emsp;&emsp;åœ¨æ­¤ä¹‹åï¼Œæ‰€æœ‰ç”±Set.newåˆ›å»ºçš„é›†åˆéƒ½å…·æœ‰ä¸€ä¸ªç›¸åŒçš„å…ƒè¡¨ï¼š

```lua
    s1 = Set.new{10, 20, 30, 50}
    s2 = Set.new{30, 1}
    print(getmetatable(s1))    --> table: 00672B60
    print(getmetatable(s2))    --> table: 00672B60
```

&emsp;&emsp;æœ€åï¼Œå°†å…ƒæ–¹æ³•åŠ å…¥å…ƒè¡¨ä¸­ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œè¿™ä¸ªå…ƒæ–¹æ³•å°±æ˜¯ç”¨äºæè¿°å¦‚ä½•å®ŒæˆåŠ æ³•çš„`__add`å­—æ®µã€‚

```lua
    mt.__add = Set.union
```

&emsp;&emsp;æ­¤ååªè¦Luaè¯•å›¾å°†ä¸¤ä¸ªé›†åˆç›¸åŠ ï¼Œå®ƒå°±ä¼šè°ƒç”¨Set.unionå‡½æ•°ï¼Œå¹¶å°†ä¸¤ä¸ªæ“ä½œæ•°ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚å¯ä»¥ä½¿ç”¨åŠ å·æ¥æ±‚é›†åˆçš„å¹¶é›†ï¼š

```lua
    s3 = s1 + s2
    Set.print(s3)        -->  {1, 10, 20, 30, 50}
```

&emsp;&emsp;ç±»ä¼¼åœ°ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ä¹˜å·æ¥æ±‚é›†åˆçš„äº¤é›†ï¼š

```lua
    mt.__mul = Set.intersection
    Set.print((s1 + s2)*s1)    --> {10, 20, 30, 50}
```

&emsp;&emsp;åœ¨å…ƒè¡¨ä¸­ï¼Œæ¯ç§ç®—æœ¯æ“ä½œç¬¦éƒ½æœ‰å¯¹åº”çš„å­—æ®µåã€‚é™¤äº†ä¸Šè¿°çš„`__add`å’Œ`__mul`å¤–ï¼Œè¿˜æœ‰`__sub`ï¼ˆå‡æ³•ï¼‰ã€`__div`ï¼ˆé™¤æ³•ï¼‰ã€`__unm`ï¼ˆç›¸åæ•°ï¼‰ã€`__mod`ï¼ˆå–æ¨¡ï¼‰å’Œ`__pow`ï¼ˆä¹˜å¹‚ï¼‰ã€‚æ­¤å¤–ï¼Œè¿˜å¯ä»¥å®šä¹‰`__concat`å­—æ®µï¼Œç”¨äºæè¿°è¿æ¥æ“ä½œç¬¦çš„è¡Œä¸ºã€‚

&emsp;&emsp;å½“ä¸¤ä¸ªé›†åˆç›¸åŠ æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ä»»æ„ä¸€ä¸ªé›†åˆçš„å…ƒè¡¨ã€‚ç„¶è€Œï¼Œå½“ä¸€ä¸ªè¡¨è¾¾å¼ä¸­æ··åˆäº†å…·æœ‰ä¸åŒå…ƒè¡¨çš„å€¼æ—¶ï¼Œä¾‹å¦‚ï¼š

```lua
    s = Set.new{1, 2, 3}
    s = s + 8
```

&emsp;&emsp;Luaä¼šæŒ‰ç…§å¦‚ä¸‹æ­¥éª¤æ¥æŸ¥æ‰¾å…ƒè¡¨ï¼šå¦‚æœç¬¬ä¸€ä¸ªå€¼æœ‰å…ƒè¡¨ï¼Œå¹¶ä¸”å…ƒè¡¨ä¸­æœ‰`__add`å­—æ®µï¼Œé‚£ä¹ˆLuaå°±ä»¥è¿™ä¸ªå­—æ®µä¸ºå…ƒæ–¹æ³•ï¼Œè€Œä¸ç¬¬äºŒä¸ªå€¼æ— å…³ï¼›åä¹‹ï¼Œå¦‚æœç¬¬äºŒä¸ªå€¼æœ‰å…ƒè¡¨å¹¶å«æœ‰`__add`å­—æ®µï¼ŒLuaå°±ä»¥æ­¤å­—æ®µä¸ºå…ƒæ–¹æ³•ï¼›å¦‚æœä¸¤ä¸ªå€¼éƒ½æ²¡æœ‰å…ƒæ–¹æ³•ï¼ŒLuaå°±å¼•å‘ä¸€ä¸ªé”™è¯¯ã€‚å› æ­¤ï¼Œä¸Šä¾‹ä¼šè°ƒç”¨Set.unionï¼Œè€Œè¡¨è¾¾å¼10+så’Œâ€œhelloâ€+sä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚

&emsp;&emsp;Luaå¯ä»¥åŒ…å«è¿™äº›æ··åˆç±»å‹ï¼Œä½†å®ç°éœ€è¦æ³¨æ„å¦‚æœæ‰§è¡Œäº†s=s+8ï¼Œé‚£ä¹ˆåœ¨Set.unionå†…éƒ¨å°±ä¼šå‘ç”Ÿé”™è¯¯ï¼š

```lua
    bad argument $1 to 'pairs' (table expected, got number)
```

&emsp;&emsp;å¦‚æœæƒ³è¦å¾—åˆ°æ›´æ¸…æ¥šçš„é”™è¯¯æ¶ˆæ¯ï¼Œåˆ™å¿…é¡»åœ¨å®é™…æ“ä½œå‰æ˜¾å¼åœ°æ£€æŸ¥æ“ä½œæ•°çš„ç±»å‹ï¼š

```lua
    function Set.union(a, b)
        if getmetatable(a) ~= mt or getmetatable(b) ~= mt then
            error("attempt to 'add' a set with a non-set value", 2)
        end
        <ä¸å‰ä¾‹ç›¸åŒçš„å†…å®¹>
```

&emsp;&emsp;æ³¨æ„ï¼Œerrorçš„ç¬¬äºŒä¸ªå‚æ•°ï¼ˆä¸Šä¾‹ä¸­çš„2ï¼‰ç”¨äºæŒ‡ç¤ºå“ªä¸ªå‡½æ•°è°ƒç”¨é€ æˆäº†è¯¥é”™è¯¯æ¶ˆæ¯ã€‚

&emsp;&emsp;

####å…³ç³»ç±»çš„å…ƒæ–¹æ³•

&emsp;&emsp;å…ƒè¡¨è¿˜å¯ä»¥æŒ‡å®šå…³ç³»æ“ä½œç¬¦çš„å«ä¹‰ï¼Œå…ƒæ–¹æ³•ä¸º`__eq`ï¼ˆç­‰äºï¼‰ã€`__lt`ï¼ˆå°äºï¼‰å’Œ`__le`ï¼ˆå°äºç­‰äºï¼‰ã€‚è€Œå…¶ä»–3ä¸ªå…³ç³»æ“ä½œç¬¦åˆ™æ²¡æœ‰å•ç‹¬çš„å…ƒæ–¹æ³•ï¼ŒLuaä¼šå°†`a~=b`è½¬åŒ–ä¸º`not(a==b)`ï¼Œå°†`a>b`è½¬åŒ–ä¸º`b<a`ï¼Œå°†`a>=b`è½¬åŒ–ä¸º`b<=a`ã€‚


&emsp;&emsp;åœ¨Lua4.0ä¹‹å‰ï¼Œæ‰€æœ‰çš„é¡ºåºæ“ä½œç¬¦éƒ½è¢«è½¬åŒ–ä¸ºä¸€ç§æ“ä½œç¬¦ï¼ˆå°äºï¼‰ï¼Œä¾‹å¦‚ï¼Œ`a<=b`è½¬åŒ–ä¸º`not(b<a)`ã€‚ä¸è¿‡ï¼Œè¿™ç§è½¬åŒ–é‡åˆ°â€œéƒ¨åˆ†æœ‰åºï¼ˆpartial orderï¼‰â€å°±ä¼šå‘ç”Ÿé”™è¯¯ã€‚æ‰€è°“â€œéƒ¨åˆ†æœ‰åºâ€æ˜¯æŒ‡ï¼Œå¯¹äºä¸€ç§ç±»å‹è€Œè¨€ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„å€¼éƒ½èƒ½æ’åºçš„ã€‚ä¾‹å¦‚ï¼Œå¤§å¤šæ•°è®¡ç®—æœºä¸­çš„æµ®ç‚¹æ•°å°±ä¸æ˜¯å®Œå…¨å¯ä»¥æ’åºçš„ã€‚å› ä¸ºå­˜åœ¨ç€ä¸€ç§å«â€œNot a Number(NaN)â€çš„å€¼ã€‚IEEE754æ˜¯ä¸€ä»½å½“å‰æ‰€æœ‰æµ®ç‚¹æ•°ç¡¬ä»¶éƒ½é‡‡ç”¨çš„äº‹å®æ ‡å‡†ï¼Œå…¶ä¸­å°†NaNè§†ä¸ºä¸€ç§æœªå®šä¹‰çš„å€¼ï¼Œä¾‹å¦‚0/0çš„ç»“æœå°±æ˜¯NaNã€‚æ ‡å‡†è§„å®šäº†ä»»ä½•æ¶‰åŠNaNçš„æ¯”è¾ƒéƒ½åº”è¿”å›falseï¼ˆå‡ï¼‰ã€‚è¿™æ„å‘³ç€`NaN<=x`æ°¸è¿œä¸ºå‡ï¼Œä½†æ˜¯`x<NaN`ä¹Ÿä¸ºå‡ã€‚å› æ­¤ï¼Œå‰é¢æåˆ°çš„å°†`a<=b`è½¬åŒ–ä¸º`not(b<a)`å°±ä¸åˆæ³•äº†ã€‚

&emsp;&emsp;åœ¨ä¸Šé¢çš„é›†åˆç¤ºä¾‹ä¸­ï¼Œä¹Ÿå­˜åœ¨ç€ç±»ä¼¼çš„é—®é¢˜ã€‚åœ¨é›†åˆæ“ä½œä¸­`<=`é€šå¸¸è¡¨ç¤ºé›†åˆé—´çš„åŒ…å«å…³ç³»ï¼š`a<=b`é€šå¸¸æ„å‘³ç€aæ˜¯bçš„ä¸€ä¸ªå­é›†ã€‚æ ¹æ®è¿™æ ·çš„è¡¨ç¤ºï¼Œä»æœ‰å¯èƒ½å¾—åˆ°`a<=b`å’Œ`b<a`åŒæ—¶ä¸ºå‡çš„æƒ…å†µã€‚å› æ­¤éœ€è¦åˆ†åˆ«ä¸º`__le`ï¼ˆå°äºç­‰äºï¼‰å’Œ`__lt`ï¼ˆå°äºï¼‰æä¾›å®ç°ï¼š

```lua
mt.__le = function(a, b)		-- é›†åˆåŒ…å«
              for k in pairs(a) do
                  if not b[k] then return false end
              end
              return true
           end

    mt.__lt = function(a, b)
                  return a<=b and not (b<=a)
              end
```

&emsp;&emsp;æœ€åï¼Œè¿˜å¯ä»¥å®šä¹‰é›†åˆçš„ç›¸ç­‰æ€§åˆ¤æ–­ï¼š

```lua
    mt.__eq = function(a, b)
                  return a <= b and b <= a
              end
```

&emsp;&emsp;æœ‰äº†è¿™äº›å®šä¹‰åï¼Œå°±å¯ä»¥æ¯”è¾ƒé›†åˆäº†ï¼š

```lua
    s1 = Set.new{2, 4}
    s2 = Set.new{4, 10, 2}
    print(s1 <= s2)			-- true
    print(s1 < s2)			-- true
    print(s1 >= s1)			-- true
    print(s1 > s1)			-- false
    print(s1 == s2 * s1)	-- true
```

&emsp;&emsp;ä¸ç®—æœ¯ç±»çš„å…ƒæ–¹æ³•ä¸åŒçš„æ˜¯ï¼Œå…³ç³»ç±»çš„å…ƒæ–¹æ³•ä¸èƒ½åº”ç”¨äºæ··åˆçš„ç±»å‹ã€‚å¯¹äºæ··åˆç±»å‹è€Œè¨€ï¼Œå…³ç³»ç±»å…ƒæ–¹æ³•çš„è¡Œä¸ºå°±æ¨¡æ‹Ÿè¿™äº›æ“ä½œç¬¦åœ¨Luaä¸­æ™®é€šçš„è¡Œä¸ºã€‚å¦‚æœè¯•å›¾å°†ä¸€ä¸ªå­—ç¬¦ä¸²ä¸ä¸€ä¸ªæ•°å­—ä½œé¡ºåºæ€§æ¯”è¾ƒï¼ŒLuaä¼šå¼•å‘ä¸€ä¸ªé”™è¯¯ã€‚åŒæ ·ï¼Œå¦‚æœè¯•å›¾æ¯”è¾ƒä¸¤ä¸ªå…·æœ‰ä¸åŒå…ƒæ–¹æ³•çš„å¯¹è±¡ï¼ŒLuaä¹Ÿä¼šå¼•å‘ä¸€ä¸ªé”™è¯¯ã€‚

&emsp;&emsp;ç­‰äºæ¯”è¾ƒæ°¸è¿œä¸ä¼šå¼•å‘é”™è¯¯ã€‚ä½†æ˜¯å¦‚æœä¸¤ä¸ªå¯¹è±¡æ‹¥æœ‰ä¸åŒçš„å…ƒæ–¹æ³•ï¼Œé‚£ä¹ˆç­‰äºæ“ä½œä¸ä¼šè°ƒç”¨ä»»ä½•ä¸€ä¸ªå…ƒæ–¹æ³•ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›falseã€‚è¿™ç§è¡Œä¸ºæ¨¡æ‹Ÿäº†Luaçš„æ™®é€šè¡Œä¸ºã€‚åœ¨Luaçš„æ™®é€šè¡Œä¸ºä¸­ï¼Œå­—ç¬¦ä¸²æ€»æ˜¯ä¸ç­‰äºæ•°å­—çš„ï¼Œä¸å®ƒä»¬çš„å€¼æ— å…³ã€‚å¦å¤–ï¼Œåªæœ‰å½“ä¸¤ä¸ªæ¯”è¾ƒå¯¹è±¡å…±äº«ä¸€ä¸ªå…ƒæ–¹æ³•æ—¶ï¼ŒLuaæ‰è°ƒç”¨è¿™ä¸ªç­‰äºæ¯”è¾ƒçš„å…ƒæ–¹æ³•ã€‚

&emsp;&emsp;


####åº“å®šä¹‰çš„å…ƒæ–¹æ³•

&emsp;&emsp;å„ç§ç¨‹åºåº“åœ¨å…ƒè¡¨ä¸­å®šä¹‰å®ƒä»¬è‡ªå·±çš„å­—æ®µæ˜¯å¾ˆæ™®é€šçš„æ–¹æ³•ã€‚åˆ°ç›®å‰ä¸ºæ­¢ä»‹ç»çš„æ‰€æœ‰å…ƒæ–¹æ³•éƒ½åªé’ˆå¯¹äºLuaçš„æ ¸å¿ƒï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªè™šæ‹Ÿæœºï¼ˆvirtual machineï¼‰ã€‚å®ƒä¼šæ£€æµ‹ä¸€ä¸ªæ“ä½œä¸­çš„å€¼æ˜¯å¦æœ‰å…ƒè¡¨ï¼Œè¿™äº›å…ƒè¡¨ä¸­æ˜¯å¦å®šä¹‰äº†å…³äºæ­¤æ“ä½œçš„å…ƒæ–¹æ³•ã€‚ä»å¦ä¸€æ–¹é¢è¯´ï¼Œç”±äºå…ƒè¡¨ä¹Ÿæ˜¯ä¸€ç§å¸¸è§„çš„tableï¼Œæ‰€ä»¥ä»»ä½•äººã€ä»»ä½•å‡½æ•°éƒ½å¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚

&emsp;&emsp;å‡½æ•°`tostring`å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„å®ä¾‹ã€‚åœ¨å‰é¢å·²ä»‹ç»è¿‡`tostring`äº†ï¼Œå®ƒèƒ½å°†å„ç§ç±»å‹çš„å€¼è¡¨ç¤ºä¸ºä¸€ç§ç®€å•çš„æ–‡æœ¬æ ¼å¼ï¼š

```lua
    print({})			--> table: 0x8062ac0
```

&emsp;&emsp;å‡½æ•°`print`æ€»æ˜¯è°ƒç”¨`tostring`æ¥æ ¼å¼åŒ–å…¶è¾“å‡ºã€‚å½“æ ¼å¼åŒ–ä»»æ„å€¼æ—¶ï¼Œ`tostring`ä¼šæ£€æŸ¥è¯¥å€¼æ˜¯å¦æœ‰ä¸€ä¸ª`__tostring`çš„å…ƒæ–¹æ³•ã€‚å¦‚æœæœ‰è¿™ä¸ªå…ƒæ–¹æ³•ï¼Œ`tostring`å°±ç”¨è¯¥å€¼ä½œä¸ºå‚æ•°æ¥è°ƒç”¨è¿™ä¸ªå…ƒæ–¹æ³•ã€‚æ¥ä¸‹æ¥ç”±è¿™ä¸ªå…ƒæ–¹æ³•å®Œæˆå®ç°çš„å·¥ä½œï¼Œå®ƒè¿”å›çš„ç»“æœä¹Ÿå°±æ˜¯`tostring`çš„ç»“æœã€‚

&emsp;&emsp;åœ¨é›†åˆçš„ç¤ºä¾‹ä¸­ï¼Œå·²å®šä¹‰äº†ä¸€ä¸ªå°†é›†åˆè¡¨ç¤ºä¸ºå­—ç¬¦ä¸²çš„å‡½æ•°ã€‚æ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯è®¾ç½®å…ƒè¡¨çš„`__tostring`å­—æ®µï¼š

```lua
    mt.__tostring = Set.tostring
```

&emsp;&emsp;æ­¤ååªè¦è°ƒç”¨`print`æ¥æ‰“å°é›†åˆï¼Œ`print`å°±ä¼šè°ƒç”¨`tostring`å‡½æ•°ï¼Œè¿›è€Œè°ƒç”¨åˆ°`Set.tostring`ï¼š

```lua
    s1 = Set.new{10, 4, 5}
    print(s1)				--> {4, 5, 10}
```

&emsp;&emsp;å‡½æ•°`setmetatable`å’Œ`getmetatable`ä¹Ÿä¼šç”¨åˆ°å…ƒè¡¨ä¸­çš„ä¸€ä¸ªå­—æ®µï¼Œç”¨äºä¿æŠ¤å…ƒè¡¨ã€‚å‡è®¾æƒ³è¦ä¿æŠ¤é›†åˆçš„å…ƒè¡¨ï¼Œä½¿ç”¨æˆ·æ—¢ä¸èƒ½çœ‹ä¹Ÿä¸èƒ½ä¿®æ”¹é›†åˆçš„å…ƒè¡¨ã€‚é‚£ä¹ˆå°±éœ€è¦ç”¨åˆ°å­—æ®µ`__metatable`ã€‚å½“è®¾ç½®äº†è¯¥å­—æ®µæ—¶ï¼Œ`getmetatable`å°±ä¼šè¿”å›è¿™ä¸ªå­—æ®µçš„å€¼ï¼Œè€Œ`setmetatable`åˆ™ä¼šå¼•å‘ä¸€ä¸ªé”™è¯¯ï¼š

```lua
    mt.__metatable = "not your business"

    s1 = Set.new{}
    print(getmetatable(s1))		--> not your business
    setmetatable(s1, {})
    stdin:1: cannot change protected metatable
```

&emsp;&emsp;

####tableè®¿é—®çš„å…ƒæ–¹æ³•

&emsp;&emsp;ç®—æœ¯ç±»å’Œå…³ç³»ç±»å…ƒç®—ç¬¦çš„å…ƒæ–¹æ³•éƒ½ä¸ºå„ç§é”™è¯¯æƒ…å†µå®šä¹‰äº†è¡Œä¸ºï¼Œå®ƒä»¬ä¸ä¼šæ”¹å˜è¯­è¨€çš„å¸¸è§„è¡Œä¸ºã€‚ä½†æ˜¯Luaè¿˜æä¾›äº†ä¸€ç§å¯ä»¥æ”¹å˜tableè¡Œä¸ºçš„æ–¹æ³•ã€‚æœ‰ä¸¤ç§å¯ä»¥æ”¹å˜çš„tableè¡Œä¸ºï¼šæŸ¥è¯¢tableåŠä¿®æ”¹tableä¸­ä¸å­˜åœ¨çš„å­—æ®µã€‚

#####â— __indexå…ƒæ–¹æ³•

å½“è®¿é—®ä¸€ä¸ªtableä¸­ä¸å­˜åœ¨çš„å­—æ®µæ—¶ï¼Œå¾—åˆ°çš„ç»“æœä¸ºnilã€‚è¿™æ˜¯å¯¹çš„ï¼Œä½†å¹¶éå®Œå…¨æ­£ç¡®ã€‚å®é™…ä¸Šï¼Œè¿™äº›è®¿é—®ä¼šä¿ƒä½¿è§£é‡Šå™¨å»æŸ¥æ‰¾ä¸€ä¸ªå«__indexçš„å…ƒæ–¹æ³•ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªå…ƒæ–¹æ³•ï¼Œé‚£ä¹ˆè®¿é—®ç»“æœå¦‚å‰è¿°çš„ä¸ºnilã€‚å¦åˆ™ï¼Œå°±ç”±è¿™ä¸ªå…ƒæ–¹æ³•æ¥æä¾›æœ€ç»ˆç»“æœã€‚

&emsp;&emsp;ä¸‹é¢å°†ä»‹ç»ä¸€ä¸ªæœ‰å…³ç»§æ‰¿çš„å…¸å‹ç¤ºä¾‹ã€‚å‡è®¾è¦åˆ›å»ºä¸€äº›æè¿°çª—å£çš„tableï¼Œæ¯ä¸ªtableä¸­å¿…é¡»æè¿°ä¸€äº›çª—å£å‚æ•°ï¼Œä¾‹å¦‚ä½ç½®ã€å¤§å°åŠä¸»é¢˜é¢œè‰²ç­‰ã€‚æ‰€æœ‰è¿™äº›å‚æ•°éƒ½æœ‰é»˜è®¤å€¼ï¼Œå› æ­¤å¸Œæœ›åœ¨åˆ›å»ºçª—å£å¯¹è±¡æ—¶å¯ä»¥ä»…æŒ‡å®šé‚£äº›ä¸åŒäºé»˜è®¤å€¼çš„å‚æ•°ã€‚ç¬¬ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ä¸€ä¸ªæ„é€ å¼ï¼Œåœ¨å…¶ä¸­å¡«å†™é‚£äº›ä¸å­˜åœ¨çš„å­—æ®µã€‚ç¬¬äºŒç§æ–¹æ³•æ˜¯è®©æ–°çª—å£ä»ä¸€ä¸ªåŸå‹çª—å£å¤„ç»§æ‰¿æ‰€æœ‰ä¸å­˜åœ¨çš„å­—æ®µã€‚é¦–å…ˆï¼Œå£°æ˜ä¸€ä¸ªåŸå‹å’Œä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œæ„é€ å‡½æ•°åˆ›å»ºæ–°çš„çª—å£ï¼Œå¹¶ä½¿å®ƒä»¬å…±äº«åŒä¸€ä¸ªå…ƒè¡¨ï¼š

```lua
    Window = {} 		-- åˆ›å»ºä¸€ä¸ªåå­—ç©ºé—´
    -- ä½¿ç”¨é»˜è®¤å€¼æ¥åˆ›å»ºä¸€ä¸ªåŸå‹
    Window.prototype = {x=0, y=0, width=100, height=100}
    Window.mt = {} 		-- åˆ›å»ºå…ƒè¡¨
    -- å£°æ˜æ„é€ å‡½æ•°
    function Window.new(o)
        setmetatable(o, Window.mt)
        return o
    end
```

&emsp;&emsp;ç°åœ¨ï¼Œæ¥å®šä¹‰`__index`å…ƒæ–¹æ³•ï¼š

```lua
    Window.mt.__index = function(table, key)
        return Window.prototype[key]
    end
```

&emsp;&emsp;åœ¨è¿™æ®µä»£ç ä¹‹åï¼Œåˆ›å»ºä¸€ä¸ªæ–°çª—å£ï¼Œå¹¶æŸ¥è¯¢ä¸€ä¸ªå®ƒæ²¡æœ‰çš„å­—æ®µï¼š

```lua
    w = Window.new{x=10, y=20}
    print(w.width)			--> 100
```

&emsp;&emsp;è‹¥Luaæ£€æµ‹åˆ°`w`ä¸­æ²¡æœ‰æŸå­—æ®µï¼Œä½†åœ¨å…¶å…ƒè¡¨ä¸­å´æœ‰ä¸€ä¸ª`__index`å­—æ®µï¼Œé‚£ä¹ˆLuaå°±ä¼šä»¥`w(table)`å’Œâ€œ`width`â€ï¼ˆä¸å­˜åœ¨çš„keyï¼‰æ¥è°ƒç”¨è¿™ä¸ª`__index`å…ƒæ–¹æ³•ã€‚éšåå…ƒæ–¹æ³•ç”¨è¿™ä¸ªkeyæ¥ç´¢å¼•åŸå‹tableï¼Œå¹¶è¿”å›ç»“æœã€‚

&emsp;&emsp;åœ¨Luaä¸­ï¼Œå°†`__index`å…ƒæ–¹æ³•ç”¨äºç»§æ‰¿æ˜¯å¾ˆæ™®é€šçš„æ–¹æ³•ï¼Œå› æ­¤Luaè¿˜æä¾›äº†ä¸€ç§æ›´ä¾¿æ·çš„æ–¹å¼æ¥å®ç°æ­¤åŠŸèƒ½ã€‚`__index`å…ƒæ–¹æ³•ä¸å¿…ä¸€å®šæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒè¿˜å¯ä»¥æ˜¯ä¸€ä¸ªtableã€‚å½“å®ƒæ˜¯ä¸€ä¸ªå‡½æ•°æ—¶ï¼ŒLuaä»¥tableå’Œä¸å­˜åœ¨çš„keyä½œä¸ºå‚æ•°æ¥è°ƒç”¨è¯¥å‡½æ•°ï¼Œè¿™å°±å¦‚åŒä¸Šè¿°å†…å®¹ã€‚è€Œå½“å®ƒæ˜¯ä¸€ä¸ªtableæ—¶ï¼ŒLuaå°±ä»¥ç›¸åŒçš„æ–¹å¼æ¥é‡æ–°è®¿é—®è¿™ä¸ªtableã€‚å› æ­¤ï¼Œå‰ä¾‹ä¸­`__index`çš„å£°æ˜å¯ä»¥ç®€å•åœ°å†™ä¸ºï¼š

```lua
    Window.mt.__index = Window.prototype
```

&emsp;&emsp;ç°åœ¨ï¼Œå½“LuaæŸ¥æ‰¾åˆ°å…ƒè¡¨çš„`__index`å­—æ®µæ—¶ï¼Œå‘ç°`__index`å­—æ®µçš„å€¼æ˜¯ä¸€ä¸ªtableï¼Œé‚£ä¹ˆLuaå°±ä¼šåœ¨Window.prototypeä¸­ç»§ç»­æŸ¥æ‰¾ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒLuaä¼šåœ¨è¿™ä¸ªtableä¸­é‡å¤è¿™ä¸ªè®¿é—®è¿‡ç¨‹ï¼Œç±»ä¼¼äºæ‰§è¡Œè¿™æ ·çš„ä»£ç ï¼š

```lua
    Window.prototype["width"]
```

&emsp;&emsp;ç„¶åç”±è¿™æ¬¡è®¿é—®ç»™å‡ºæƒ³è¦çš„ç»“æœã€‚

&emsp;&emsp;å°†ä¸€ä¸ªtableä½œä¸º`__index`å…ƒæ–¹æ³•æ˜¯ä¸€ç§å¿«æ·çš„ã€å®ç°å•ä¸€ç»§æ‰¿çš„æ–¹å¼ã€‚è™½ç„¶å°†å‡½æ•°ä½œä¸º`__index`æ¥å®ç°ç›¸åŒåŠŸèƒ½çš„å¼€é”€è¾ƒå¤§ï¼Œä½†å‡½æ•°æ›´åŠ çµæ´»ã€‚å¯ä»¥é€šè¿‡å‡½æ•°æ¥å®ç°å¤šé‡ç»§æ‰¿ã€ç¼“å­˜åŠå…¶ä»–ä¸€äº›åŠŸèƒ½ã€‚

&emsp;&emsp;å¦‚æœä¸æƒ³åœ¨è®¿é—®ä¸€ä¸ªtableæ—¶æ¶‰åŠåˆ°å®ƒçš„`__index`å…ƒæ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨å‡½æ•°`rawget`ã€‚è°ƒç”¨`rawget(t, i)`å°±æ˜¯å¯¹table tè¿›è¡Œäº†ä¸€ä¸ªâ€œåŸå§‹çš„(raw)â€è®¿é—®ï¼Œä¹Ÿå°±æ˜¯ä¸€æ¬¡ä¸è€ƒè™‘å…ƒè¡¨çš„ç®€å•è®¿é—®ã€‚ä¸€æ¬¡åŸå§‹è®¿é—®å¹¶ä¸ä¼šåŠ é€Ÿä»£ç æ‰§è¡Œï¼Œä½†æœ‰æ—¶ä¼šç”¨åˆ°å®ƒã€‚

#####â— __newindexå…ƒæ–¹æ³•

&emsp;&emsp;**`__newindex`å…ƒæ–¹æ³•ä¸`__index`ç±»ä¼¼ï¼Œä¸åŒä¹‹å¤„åœ¨äºå‰è€…ç”¨äºtableçš„æ›´æ–°ï¼Œè€Œåè€…ç”¨äºtableçš„æŸ¥è¯¢**ã€‚å½“å¯¹ä¸€ä¸ªtableä¸­ä¸å­˜åœ¨çš„ç´¢å¼•èµ‹å€¼æ—¶ï¼Œè§£é‡Šå™¨å°±ä¼šæŸ¥æ‰¾`__newindex`å…ƒæ–¹æ³•ã€‚å¦‚æœæœ‰è¿™ä¸ªå…ƒæ–¹æ³•ï¼Œè§£é‡Šå™¨å°±è°ƒç”¨å®ƒï¼Œè€Œä¸æ˜¯æ‰§è¡Œèµ‹å€¼ã€‚å¦‚æœè¿™ä¸ªå…ƒæ–¹æ³•æ˜¯ä¸€ä¸ªtableï¼Œè§£é‡Šå™¨å°±åœ¨æ­¤tableä¸­æ‰§è¡Œèµ‹å€¼ï¼Œè€Œä¸æ˜¯å¯¹åŸæ¥çš„tableã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªåŸå§‹å‡½æ•°å…è®¸ç»•è¿‡å…ƒæ–¹æ³•ï¼šè°ƒç”¨`rawset(t,k,v)`å°±å¯ä»¥ä¸æ¶‰åŠä»»ä½•å…ƒæ–¹æ³•è€Œç›´æ¥è®¾ç½®table tä¸­ä¸key kç›¸å…³è”çš„value vã€‚

&emsp;&emsp;ç»„åˆä½¿ç”¨`__index`å’Œ`__newindex`å…ƒæ–¹æ³•å°±å¯ä»¥å®ç°å‡ºLuaä¸­çš„ä¸€äº›å¼ºå¤§åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼Œåªè¯»çš„tableã€å…·æœ‰é»˜è®¤å€¼çš„tableå’Œé¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­çš„ç»§æ‰¿ã€‚

&emsp;&emsp;

#####â— å…·æœ‰é»˜è®¤å€¼çš„table

&emsp;&emsp;å¸¸è§„tableä¸­çš„ä»»ä½•å­—æ®µé»˜è®¤éƒ½æ˜¯nilã€‚é€šè¿‡å…ƒè¡¨å°±å¯ä»¥å¾ˆå®¹æ˜“åœ°ä¿®æ”¹è¿™ä¸ªé»˜è®¤å€¼ï¼š

```lua
    function setDefault(t, d)
        local mt = {__index = function() return d end}
        setmetatable(t, mt)
    end

    tab = {x=10, y=20}
    print(tab.x, tab.z)			--> 10 nil
    setDefault(tab, 0)
    print(tab.x, tab.z)			--> 10 0
```

&emsp;&emsp;åœ¨è°ƒç”¨`setDefault`åï¼Œä»»ä½•å¯¹tabä¸­å­˜åœ¨å­—æ®µçš„è®¿é—®éƒ½å°†è°ƒç”¨å®ƒçš„`__index`å…ƒæ–¹æ³•ï¼Œè€Œè¿™ä¸ªå…ƒæ–¹æ³•ä¼šè¿”å›0ï¼ˆè¿™ä¸ªå…ƒæ–¹æ³•ä¸­dçš„å€¼ï¼‰ã€‚

&emsp;&emsp;`setDefault`å‡½æ•°ä¸ºæ‰€æœ‰éœ€è¦é»˜è®¤å€¼çš„tableåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å…ƒè¡¨ã€‚å¦‚æœå‡†å¤‡åˆ›å»ºå¾ˆå¤šéœ€è¦é»˜è®¤å€¼çš„tableï¼Œè¿™ç§æ–¹æ³•çš„å¼€é”€æˆ–è®¸å°±æ¯”è¾ƒå¤§äº†ã€‚ç”±äºåœ¨å…ƒè¡¨ä¸­é»˜è®¤å€¼dæ˜¯ä¸å…ƒæ–¹æ³•å…³è”åœ¨ä¸€èµ·çš„ï¼Œæ‰€ä»¥`setDefault`æ— æ³•ä¸ºæ‰€æœ‰tableéƒ½ä½¿ç”¨åŒä¸€ä¸ªå…ƒè¡¨ã€‚è‹¥è¦è®©å…·æœ‰ä¸åŒé»˜è®¤å€¼çš„tableéƒ½ä½¿ç”¨åŒä¸€ä¸ªå…ƒè¡¨ï¼Œé‚£ä¹ˆå°±éœ€è¦å°†æ¯ä¸ªå…ƒè¡¨çš„é»˜è®¤å€¼éƒ½å­˜æ”¾åˆ°tableæœ¬èº«ä¸­ã€‚å¯ä»¥ä½¿ç”¨é¢å¤–çš„å­—æ®µæ¥ä¿æŒé»˜è®¤å€¼ã€‚å¦‚æœä¸æ‹…å¿ƒåå­—å†²çªçš„è¯ï¼Œå¯ä»¥ä½¿ç”¨â€œ`___`â€è¿™æ ·çš„keyä½œä¸ºè¿™ä¸ªé¢å¤–çš„å­—æ®µï¼š

```lua
    local mt = {__index = function(t) return t.___ end}
    function setDefault(t, d)
        t.___ = d
        setmetatable(t, mt)
    end
```

&emsp;&emsp;å¦‚æœæ‹…å¿ƒåç§°å†²çªï¼Œé‚£ä¹ˆè¦ç¡®ä¿è¿™ä¸ªç‰¹æ®Škeyçš„å”¯ä¸€æ€§ä¹Ÿå¾ˆå®¹æ˜“ã€‚åªéœ€åˆ›å»ºä¸€ä¸ªæ–°çš„tableï¼Œå¹¶ç”¨å®ƒä½œä¸ºkeyå³å¯ï¼š

```lua
    local key = {} 			-- å”¯ä¸€çš„key
    local mt = {__index = function(t) return t[key] end}
    function setDefault(t, d)
        t[key] = d
        setmetatable(t, mt)
    end
```

&emsp;&emsp;è¿˜æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥å°†tableä¸å…¶é»˜è®¤å€¼å…³è”èµ·æ¥ï¼šä½¿ç”¨ä¸€ä¸ªç‹¬ç«‹çš„tableï¼Œå®ƒçš„keyä¸ºå„ç§tableï¼Œvalueå°±æ˜¯å„ç§tableçš„é»˜è®¤å€¼ã€‚ä¸è¿‡ï¼Œä¸ºäº†æ­£ç¡®åœ°å®ç°è¿™ç§åšæ³•ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ç§ç‰¹æ®Šæ€§è´¨çš„tableï¼Œå°±æ˜¯â€œ`å¼±å¼•ç”¨table(Weak Table)`â€ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬å°±ä¸ä½¿ç”¨å®ƒäº†ã€‚å°†åœ¨åç»­ç« èŠ‚ä¸­è¯¦ç»†è®¨è®ºã€‚

&emsp;&emsp;


#####â— è·Ÿè¸ªtableçš„è®¿é—®

&emsp;&emsp;`__index`å’Œ`__newindex`éƒ½æ˜¯åœ¨tableä¸­æ²¡æœ‰æ‰€éœ€è®¿é—®çš„indexæ—¶æ‰å‘æŒ¥ä½œç”¨çš„ã€‚å› æ­¤ï¼Œåªæœ‰å°†ä¸€ä¸ªtableä¿æŒä¸ºç©ºï¼Œæ‰æœ‰å¯èƒ½æ•æ‰åˆ°æ‰€æœ‰å¯¹å®ƒçš„è®¿é—®ã€‚ä¸ºäº†ç›‘è§†ä¸€ä¸ªtableçš„æ‰€æœ‰è®¿é—®ï¼Œå°±åº”è¯¥ä¸ºçœŸæ­£çš„tableåˆ›å»ºä¸€ä¸ªä»£ç†ã€‚è¿™ä¸ªä»£ç†å°±æ˜¯ä¸€ä¸ªç©ºçš„tableï¼Œå…¶ä¸­`__index`å’Œ`__newindex`å…ƒæ–¹æ³•å¯ç”¨äºè·Ÿè¸ªæ‰€æœ‰çš„è®¿é—®ï¼Œå¹¶å°†è®¿é—®é‡å®šå‘åˆ°åŸæ¥çš„tableä¸Šã€‚å‡è®¾ï¼Œæˆ‘ä»¬æƒ³è·Ÿè¸ªtable tçš„è®¿é—®ã€‚é‚£ä¹ˆå¯ä»¥è¿™ä¹ˆåšï¼š

```lua
    t = {} 				-- åŸæ¥çš„table(åœ¨å…¶ä»–åœ°æ–¹åˆ›å»ºçš„)

    -- ä¿æŒå¯¹åŸtableçš„ä¸€ä¸ªç§æœ‰è®¿é—®
    local _t = t

    -- åˆ›å»ºä»£ç†
    t = {}

    -- åˆ›å»ºå…ƒè¡¨
    local mt = {
        __index = function(t, k)
            print("*access to element " .. tostring(k))
            return _t[k]		-- è®¿é—®åŸæ¥çš„table
        end,

        __newindex = function(t, k, v)
            print("*update of element " .. tostring(k) .. " to " .. tostring(v))
            _t[k] = v 			-- æ›´æ–°åŸæ¥çš„table
    }
    setmetatable(t, mt)
```

&emsp;&emsp;è¿™æ®µä»£ç è·Ÿè¸ªäº†æ‰€æœ‰å¯¹tçš„è®¿é—®ï¼š

```lua
    >t[2] = "hello"
    *update of element 2 to hello
    >print(t[2])
    *access to element 2
    hello
```

&emsp;&emsp;ä½†ä¸Šä¾‹ä¸­çš„æ–¹æ³•å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æ— æ³•éå†åŸæ¥çš„tableã€‚å‡½æ•°pairsåªèƒ½æ“ä½œä»£ç†tableï¼Œè€Œæ— æ³•è®¿é—®åŸæ¥çš„tableã€‚

&emsp;&emsp;å¦‚æœæƒ³è¦åŒæ—¶ç›‘è§†å‡ ä¸ªtableï¼Œæ— é¡»ä¸ºæ¯ä¸ªtableåˆ›å»ºä¸åŒçš„å…ƒè¡¨ã€‚ç›¸åï¼Œåªè¦ä»¥æŸç§å½¢å¼å°†æ¯ä¸ªä»£ç†ä¸åŸæ¥tableå…³è”èµ·æ¥ï¼Œå¹¶ä¸”æ‰€æœ‰ä»£ç†éƒ½å…±äº«ä¸€ä¸ªå…¬å…±çš„å…ƒè¡¨ã€‚è¿™ä¸ªé—®é¢˜ä¸ä¸ŠèŠ‚æ‰€è®¨è®ºçš„å°†tableä¸å…¶é»˜è®¤å€¼ç›¸å…³è”çš„é—®é¢˜ç±»ä¼¼ã€‚ä¾‹å¦‚å°†åŸæ¥çš„tableä¿å­˜åœ¨ä»£ç†tableçš„ä¸€ä¸ªç‰¹æ®Šçš„å­—æ®µä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š

```lua
    local index = {}			-- åˆ›å»ºç§æœ‰ç´¢å¼•

    local mt = {
        __index = function(t, k)
            print("*access to element " .. tostring(k))
            return t[index][k]	-- è®¿é—®åŸæ¥çš„table
        end,

        __newindex = function(t, k, v)
            print("*update of element " .. tostring(k) .. " to " .. tostring(v))
            t[index][k] = v 	-- æ›´æ–°åŸæ¥çš„table
        end
    }

    function track(t)
        local proxy = {}
        proxy[index] = t
        setmetatable(proxy, mt)
        return proxy
    end
```

&emsp;&emsp;ç°åœ¨ï¼Œè‹¥è¦ç›‘è§†table tï¼Œå”¯ä¸€è¦åšçš„å°±æ˜¯æ‰§è¡Œï¼š`t = track(t)`ã€‚

&emsp;&emsp;

#####â— åªè¯»çš„table

&emsp;&emsp;é€šè¿‡ä»£ç†çš„æ¦‚å¿µï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°å®ç°å‡ºåªè¯»çš„tableã€‚åªéœ€è·Ÿè¸ªæ‰€æœ‰å¯¹tableçš„æ›´æ–°æ“ä½œï¼Œå¹¶å¼•å‘ä¸€ä¸ªé”™è¯¯å°±å¯ä»¥äº†ã€‚ç”±äºæ— é¡»è·Ÿè¸ªæŸ¥è¯¢è®¿é—®ï¼Œæ‰€ä»¥å¯¹äº`__index`å…ƒæ–¹æ³•å¯ä»¥ç›´æ¥ä½¿ç”¨åŸtableæ¥ä»£æ›¿å‡½æ•°ã€‚è¿™ä¹Ÿæ›´ç®€å•ï¼Œå¹¶ä¸”åœ¨é‡å®šå‘æ‰€æœ‰æŸ¥è¯¢åˆ°åŸtableæ—¶æ•ˆç‡ä¹Ÿæ›´é«˜ã€‚ä¸è¿‡ï¼Œè¿™ç§åšæ³•è¦æ±‚ä¸ºæ¯ä¸ªåªè¯»ä»£ç†åˆ›å»ºä¸€ä¸ªæ–°çš„å…ƒè¡¨ï¼Œå…¶ä¸­`__index`æŒ‡å‘åŸæ¥çš„tableã€‚

```lua
    function readOnly(t)
        local proxy = {}
        local mt = {  			-- åˆ›å»ºå…ƒè¡¨
            __index = t,
            __nexindex = function(t, k, v)
                error("attempt to update a read-only table", 2)
            end
        }
        setmetatable(proxy, mt)
        return proxy
    end
```

&emsp;&emsp;ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨çš„ç¤ºä¾‹ï¼Œåˆ›å»ºäº†ä¸€ä¸ªè¡¨ç¤ºæ˜ŸæœŸçš„åªè¯»tableï¼š

```lua
    days = readOnly{"Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"}

    print(days[1])				-- Sunday
    days[2] = "Noday"
    stdin:1: attempt to update a read-only table
```



ğŸ”š